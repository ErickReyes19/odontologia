generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Permiso {
  id          String       @id @default(uuid())
  nombre      String       @unique
  descripcion String
  createAt    DateTime     @default(now())
  updateAt    DateTime     @updatedAt
  activo      Boolean
  roles       RolPermiso[]
}

model RolPermiso {
  id        String   @id @default(uuid())
  rolId     String
  permisoId String
  createAt  DateTime @default(now())

  permiso Permiso @relation(fields: [permisoId], references: [id])
  rol     Rol     @relation(fields: [rolId], references: [id])

  @@unique([rolId, permisoId])
  @@index([permisoId], map: "RolPermiso_permisoId_fkey")
}

model Rol {
  id          String       @id @default(uuid())
  nombre      String       @unique
  descripcion String
  createAt    DateTime     @default(now())
  updateAt    DateTime     @updatedAt
  activo      Boolean
  permisos    RolPermiso[]
  usuarios    Usuarios[]
}

model Empleados {
  id        String @id @default(uuid()) @db.VarChar(36)
  puesto_id String @db.VarChar(36)

  identidad       String    @db.VarChar(50)
  nombre          String    @db.VarChar(100)
  apellido        String    @db.VarChar(100)
  correo          String    @db.LongText
  FechaNacimiento DateTime? @db.DateTime(6)
  fechaIngreso    DateTime? @db.DateTime(6)
  telefono        String?   @db.VarChar(20)

  Vacaciones Int
  genero     String?  @db.VarChar(20)
  activo     Boolean  @db.Bit(1)
  createAt   DateTime @default(now())
  updateAt   DateTime @updatedAt

  // Relaciones existentes
  Puesto   Puesto    @relation(fields: [puesto_id], references: [Id], onDelete: Cascade, onUpdate: NoAction)
  Usuarios Usuarios?

  // NUEVA relación opcional 1-1
  Medico Medico?

  @@index([puesto_id])
}

model Puesto {
  Id          String      @id @db.VarChar(36)
  Nombre      String      @db.VarChar(100)
  Descripcion String      @db.VarChar(100)
  Activo      Boolean     @db.Bit(1)
  createAt    DateTime    @default(now())
  updateAt    DateTime    @updatedAt
  Empleados   Empleados[]
}

model Usuarios {
  id                  String               @id @db.VarChar(36)
  empleado_id         String               @unique(map: "IX_Usuarios_empleado_id") @db.VarChar(36)
  usuario             String               @db.VarChar(50)
  contrasena          String               @db.LongText
  DebeCambiarPassword Boolean?
  createAt            DateTime             @default(now())
  updateAt            DateTime             @updatedAt
  rol_id              String               @db.VarChar(36)
  activo              Boolean              @db.Bit(1)
  Empleados           Empleados            @relation(fields: [empleado_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_Usuarios_Empleados_empleado_id")
  rol                 Rol                  @relation(fields: [rol_id], references: [id])
  PasswordResetToken  PasswordResetToken[]

  @@index([rol_id], map: "IX_Usuarios_rol_id")
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.VarChar(36)
  userId    String   @db.VarChar(36)
  token     String   @unique @db.VarChar(128)
  expiresAt DateTime
  createdAt DateTime @default(now())

  Usuario Usuarios @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "IX_PasswordResetToken_userId")
}

model Seguro {
  id          String   @id @default(uuid()) @db.VarChar(36)
  nombre      String   @db.VarChar(100)
  descripcion String?  @db.VarChar(255)
  activo      Boolean  @db.Bit(1)
  createAt    DateTime @default(now())
  updateAt    DateTime @updatedAt

  // Relaciones
  pacientes Paciente[]
}

model Paciente {
  id              String    @id @default(uuid()) @db.VarChar(36)
  identidad       String    @unique @db.VarChar(50)
  nombre          String    @db.VarChar(100)
  apellido        String    @db.VarChar(100)
  fechaNacimiento DateTime? @db.DateTime(6)
  genero          String?   @db.VarChar(20)
  telefono        String?   @db.VarChar(20)
  correo          String?   @db.VarChar(150)
  direccion       String?   @db.VarChar(255)

  // Seguro opcional
  seguroId String? @db.VarChar(36)
  seguro   Seguro? @relation(fields: [seguroId], references: [id])

  activo   Boolean  @db.Bit(1)
  createAt DateTime @default(now())
  updateAt DateTime @updatedAt

  citas        Cita[]
  cotizaciones Cotizacion[]

  @@index([seguroId])
  planTratamientos PlanTratamiento[]
  seguimientos Seguimiento[]
}

model Profesion {
  id          String   @id @default(uuid()) @db.VarChar(36)
  nombre      String   @unique @db.VarChar(100) // Ej: Odontólogo, Médico General
  descripcion String?  @db.VarChar(255)
  activo      Boolean  @db.Bit(1)
  createAt    DateTime @default(now())
  updateAt    DateTime @updatedAt

  // Relaciones
  medicos Medico[]
}

model Servicio {
  id          String   @id @default(uuid()) @db.VarChar(36)
  nombre      String   @db.VarChar(150)
  descripcion String?  @db.VarChar(255)
  precioBase  Decimal  @db.Decimal(10, 2)
  duracionMin Int
  activo      Boolean  @db.Bit(1)
  createAt    DateTime @default(now())
  updateAt    DateTime @updatedAt

  // Relación muchos a muchos con Medico
  medicosServicios    MedicoServicio[]
  consultasServicios  ConsultaServicio[]
  cotizacionServicios CotizacionServicio[]

  @@map("Servicios")
  planEtapas PlanEtapa[]
}

model Medico {
  idEmpleado  String    @id @db.VarChar(36)
  empleado    Empleados @relation(fields: [idEmpleado], references: [id], onDelete: Cascade)
  profesionId String    @db.VarChar(36)
  profesion   Profesion @relation(fields: [profesionId], references: [id])
  activo      Boolean   @db.Bit(1)
  createAt    DateTime  @default(now())
  updateAt    DateTime  @updatedAt

  // Relación muchos a muchos con Servicio
  serviciosMedicos MedicoServicio[]

  citas Cita[]

  @@map("Medicos")
  planTratamientos PlanTratamiento[]
  planEtapas PlanEtapa[]
}

model MedicoServicio {
  id         String   @id @default(uuid())
  medicoId   String   @db.VarChar(36)
  servicioId String   @db.VarChar(36)
  createAt   DateTime @default(now())

  medico   Medico   @relation(fields: [medicoId], references: [idEmpleado])
  servicio Servicio @relation(fields: [servicioId], references: [id])

  @@unique([medicoId, servicioId])
  @@index([servicioId])
  @@map("Medicos_Servicios") // nombre de tabla intermedia
}

model Consultorio {
  id        String   @id @default(uuid()) @db.VarChar(36)
  nombre    String   @db.VarChar(50) // Ej: "Consultorio 1", "Dental A"
  ubicacion String?  @db.VarChar(150)
  activo    Boolean  @db.Bit(1)
  createAt  DateTime @default(now())
  updateAt  DateTime @updatedAt

  citas Cita[]
}

model Cita {
  id            String @id @default(uuid()) @db.VarChar(36)
  pacienteId    String @db.VarChar(36)
  medicoId      String @db.VarChar(36)
  consultorioId String @db.VarChar(36)

  fechaHora DateTime @db.DateTime(6)
  estado    String   @db.VarChar(20) // programada, atendida, cancelada

  motivo      String? @db.VarChar(255)
  observacion String? @db.VarChar(255)

  createAt DateTime @default(now())
  updateAt DateTime @updatedAt

  paciente    Paciente    @relation(fields: [pacienteId], references: [id])
  medico      Medico      @relation(fields: [medicoId], references: [idEmpleado])
  consultorio Consultorio @relation(fields: [consultorioId], references: [id])

  consulta Consulta?

  @@index([pacienteId])
  @@index([medicoId])
  @@index([consultorioId])
  seguimientos Seguimiento[]
}

model Consulta {
  id     String @id @default(uuid()) @db.VarChar(36)
  citaId String @unique @db.VarChar(36)

  diagnostico String? @db.VarChar(255)
  notas       String? @db.Text

  createAt DateTime @default(now())
  updateAt DateTime @updatedAt

  cita Cita @relation(fields: [citaId], references: [id], onDelete: Cascade)

  detalles ConsultaServicio[]

  planEtapas PlanEtapa[]
}

model ConsultaServicio {
  id         String @id @default(uuid()) @db.VarChar(36)
  consultaId String @db.VarChar(36)
  servicioId String @db.VarChar(36)

  precioAplicado Decimal @db.Decimal(10, 2)
  cantidad       Int     @default(1)

  createAt DateTime @default(now())

  consulta Consulta @relation(fields: [consultaId], references: [id], onDelete: Cascade)
  servicio Servicio @relation(fields: [servicioId], references: [id])

  @@index([consultaId])
  @@index([servicioId])
}

model Cotizacion {
  id         String @id @default(uuid()) @db.VarChar(36)
  pacienteId String @db.VarChar(36)

  fecha  DateTime @default(now())
  estado String   @db.VarChar(20)
  // borrador | enviada | aceptada | rechazada | parcial

  total Decimal @db.Decimal(10, 2)

  observacion String? @db.VarChar(255)

  createAt DateTime @default(now())
  updateAt DateTime @updatedAt

  paciente Paciente             @relation(fields: [pacienteId], references: [id])
  detalles CotizacionServicio[]

  @@index([pacienteId])
}

model CotizacionServicio {
  id           String @id @default(uuid()) @db.VarChar(36)
  cotizacionId String @db.VarChar(36)
  servicioId   String @db.VarChar(36)

  precioUnitario Decimal @db.Decimal(10, 2)
  cantidad       Int     @default(1)

  observacion String? @db.VarChar(255)

  cotizacion Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  servicio   Servicio   @relation(fields: [servicioId], references: [id])

  @@unique([cotizacionId, servicioId])
  @@index([servicioId])
}


// Estados para planes y seguimientos
enum PlanEstado {
  ACTIVO
  PAUSADO
  COMPLETADO
  CANCELADO
}

enum SeguimientoEstado {
  PROGRAMADO
  REALIZADO
  CANCELADO
  NO_ASISTIO
}

model PlanTratamiento {
  id                    String   @id @default(uuid()) @db.VarChar(36)
  pacienteId            String   @db.VarChar(36)
  nombre                String   @db.VarChar(150)      // p.ej. "Brackets - Ortodoncia completa"
  descripcion           String?  @db.VarChar(255)
  estado                PlanEstado @default(ACTIVO)
  fechaInicio           DateTime @db.DateTime(6)
  fechaFin              DateTime? @db.DateTime(6)
  medicoResponsableId   String?  @db.VarChar(36)      // opcional: quien lidera el plan

  createAt              DateTime @default(now())
  updateAt              DateTime @updatedAt

  // Relaciones
  paciente              Paciente @relation(fields: [pacienteId], references: [id])
  medicoResponsable     Medico?  @relation(fields: [medicoResponsableId], references: [idEmpleado])
  etapas                PlanEtapa[]

  @@index([pacienteId])
  @@index([medicoResponsableId])
}

model PlanEtapa {
  id                    String   @id @default(uuid()) @db.VarChar(36)
  planId                String   @db.VarChar(36)
  servicioId            String   @db.VarChar(36)       // servicio asociado a la etapa (p. ej. "ajuste")
  nombre                String   @db.VarChar(150)      // p.ej. "Ajuste Mensual"
  descripcion           String?  @db.VarChar(255)
  orden                 Int      @default(1)            // orden en el plan

  // Reglas de programación
  intervaloDias         Int?     // cada cuántos días se repite (si aplica)
  repeticiones          Int?     // cuántas veces (null = indefinido)
  programarCita         Boolean  @db.Bit(1) @default(true) // si se crea una cita por cada seguimiento
  responsableMedicoId   String?  @db.VarChar(36)        // si necesita un médico específico

  crearDesdeConsultaId  String?  @db.VarChar(36)        // opcional: si la etapa se originó desde una consulta

  createAt              DateTime @default(now())

  // Relaciones
  plan                  PlanTratamiento @relation(fields: [planId], references: [id], onDelete: Cascade)
  servicio              Servicio        @relation(fields: [servicioId], references: [id])
  responsableMedico     Medico?         @relation(fields: [responsableMedicoId], references: [idEmpleado])
  crearDesdeConsulta    Consulta?       @relation(fields: [crearDesdeConsultaId], references: [id])
  seguimientos          Seguimiento[]

  @@index([planId])
  @@index([servicioId])
  @@index([responsableMedicoId])
  @@index([crearDesdeConsultaId])
}

model Seguimiento {
  id                String            @id @default(uuid()) @db.VarChar(36)
  etapaId           String            @db.VarChar(36)
  pacienteId        String            @db.VarChar(36)
  fechaProgramada   DateTime          @db.DateTime(6)
  fechaRealizada    DateTime?         @db.DateTime(6)
  estado            SeguimientoEstado @default(PROGRAMADO)
  nota              String?           @db.VarChar(255)
  citaId            String?           @db.VarChar(36)    // si se creó una cita vinculada
  creadoPorId       String?           @db.VarChar(36)    // usuario que creó el seguimiento

  createAt          DateTime @default(now())
  updateAt          DateTime @updatedAt

  etapa             PlanEtapa @relation(fields: [etapaId], references: [id], onDelete: Cascade)
  paciente          Paciente  @relation(fields: [pacienteId], references: [id])
  cita              Cita?     @relation(fields: [citaId], references: [id])

  @@index([etapaId])
  @@index([pacienteId])
  @@index([citaId])
  @@index([fechaProgramada])
}
